---
title: "3. Combine demographic data and LDA outcomes"
author: "Lijun Peng"
date: "5/24/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(dplyr)
library(tidyverse)
library(stargazer)
library(lubridate)
library(zoo)
library(kableExtra)
library(corrplot)
library(tmap)
library(tmaptools)
```
# 1. *Import RegSO names (483)*
```{r}
# 483 regso names, after remove 39 names with multiple locations and with common meaning, this df has municipalities
regso_name_aggtdegso_ori <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/regso_names_wo_multi.csv", encoding = "UTF-8")
colnames(regso_name_aggtdegso_ori) <- c("kommun","regso","new_name")

# In this regso and new name list, 10 new names have multiple regso names, other names are the same in "regso" and "new_name", so use this list is used to aggregate regso names and regso demographical data.
# column "regso" has 483 unique regso names
# column "new_names" has 473 unique regso names, 10 of regso have new names
regso_name_aggtdegso <- regso_name_aggtdegso_ori %>% 
  select(-1)

# 483 names, this df can remove unwanted regso names
regso_aggname_only <- tibble(regso_name_aggtdegso_ori[,2])
colnames(regso_aggname_only) <- "regso"
```
# 2. *Import selected posts (i.e., neighborhood-post)*
```{r}
# the data is posts that contain neighborhood names, one post can have several names, so 194,572 are not unique posts
posts_neighbor_all <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/Flashback Data/posts_neighbor_save_3.csv", encoding = "UTF-8")

# Extract year
# library(lubridate)
posts_neighbor_all$date <- as_date(posts_neighbor_all$date)
posts_neighbor_all$year <- as.numeric(format(posts_neighbor_all$date,"%Y"))

# unique posts_neighbor, 149,864
posts_neighbor_all_uniq <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/Flashback Data/posts_neighbor_all_uniq_save_3.csv", encoding = "UTF-8")
```
# 3.  Combine regso names (483) with mention times and by year. (process) 
```{r}
# combine regso names and mention times
posts_neighbor_all_count <- posts_neighbor_all %>%
  count(name, sort = T) %>%
  right_join(regso_aggname_only, by = c("name" = "regso"))

posts_neighbor_all_count[is.na(posts_neighbor_all_count)] <- 0

posts_neighbor_all_count_save <- write.csv(posts_neighbor_all_count, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/posts_neighbor_all_count.csv", fileEncoding = "UTF-8")

posts_neighbor_all_count_year <- posts_neighbor_all %>%
  count(name, year, sort = T) %>%
  right_join(regso_aggname_only, by = c("name" = "regso")) %>% 
  pivot_wider(names_from = "year", values_from = "n")

posts_neighbor_all_count_year[is.na(posts_neighbor_all_count_year)] <- 0

posts_neighbor_all_count_year_save <- write.csv(posts_neighbor_all_count_year, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/posts_neighbor_all_count_year.csv", fileEncoding = "UTF-8")
```
## 3.1 Import mention times and post_neighbor_all_counts. Each neighborhood total mentions
```{r}
# Mentioned neighborhood names
mention_name <- read.csv("D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/mention_name_save.csv", encoding = "UTF-8")

# this df used to aggregate posts names mention times, regos = 473, new_names = 554
regso_new_aggtcount_ori <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/regso_corresponding_name_wo_multi.csv", encoding = "UTF-8") %>% 
  select(1:3)
colnames(regso_new_aggtcount_ori) <- c("regso","new_name","municipality")

posts_neighbor_all_count <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/posts_neighbor_all_count.csv", encoding = "UTF-8") %>% 
  select(-1)
colnames(posts_neighbor_all_count) <- c("new_name","n")

aggregate_new_name_count <- regso_new_aggtcount_ori %>% 
  left_join(posts_neighbor_all_count, by = "new_name") %>%
  select(-2) 

# In this regso and new name list, one regso name can have multiple new names, because spit names before. So this list is used to aggregate new names and the mention times; Combining with new_name, aggregate regso names
aggregate_new_name_count[is.na(aggregate_new_name_count)] <- 0
aggregate_new_name_count <- aggregate(n ~ ., FUN = sum, data = aggregate_new_name_count)
```
## 3.2 Import post_neighbor_all_counts_year. Each neighborhood's yearly mentions (i.e., counts)
```{r}
posts_neighbor_all_count_year <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/posts_neighbor_all_count_year.csv", fileEncoding = "UTF-8") %>% 
  select(-1,-25)

aggregate_new_name_count_year <- regso_new_aggtcount_ori %>% 
  left_join(posts_neighbor_all_count_year, by = c("new_name" = "name")) %>%
  select(-2)

aggregate_new_name_count_year[is.na(aggregate_new_name_count_year)] <- 0
aggregate_new_name_count_year <- aggregate(X2013 ~ ., FUN = sum, data = aggregate_new_name_count_year)

select_year <- c(2011,2012,2013,2014,2015,2016,2017,2018,2019,2020)
aggregate_new_name_count_year <- aggregate_new_name_count_year %>% 
  pivot_longer(cols = starts_with("X2"), names_to = "year_mention", values_to = "mention_time") %>% 
  separate(year_mention, c("remove", "year_mention"), sep = "X") %>% 
  select(-2) %>% 
  filter(year_mention %in% select_year)

aggregate_new_name_count_year$year_mention <- as.numeric(aggregate_new_name_count_year$year_mention)
```

# 4. Import demographic data
education: 2015--2020
birthregion: 2010--2020
low_high_economic_standard: 2011--2020
household_type: 2011--2020
whole population data comes from variable: gender 2011--2020
age: 2011--2020
gender: 2011-2020
## 4.1 *education* background (process)
```{r}
#"2015","2016","2017","2018","2019","2020"
education_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/regso_education2015_2020.xlsx")
colnames(education_ori) <- c("name","education","Y2015","Y2016","Y2017","Y2018","Y2019","Y2020")

education_wide <- education_ori %>% 
  filter(education != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso") %>% 
  mutate(education = case_when(education == "fC6rgymnasial utbildning" ~ "pre_secondary",
                               education == "gymnasial utbildning" ~ "secondary",
                               education == "eftergymnasial utbildning, mindre C$n 3 C%r" ~ "post_sec_l3",
                               education == "eftergymnasial utbildning, 3 C%r eller mer" ~ "post_sec_m3",
                               education == "uppgift om utbildningsnivC% saknas" ~ "info_missing")) %>% 
  pivot_wider(names_from = "education", values_from = c("Y2015","Y2016","Y2017","Y2018","Y2019","Y2020"), values_fn = NULL)

education_wide <- education_wide[!grepl("[,]", education_wide$Y2015_pre_secondary),]
education_wide[,2:31] <- sapply(education_wide[,2:31], as.numeric)

education_wide$edu_2015_total <- rowSums(education_wide[,2:6])
education_wide$edu_2016_total <- rowSums(education_wide[,7:11])
education_wide$edu_2017_total <- rowSums(education_wide[,12:16])
education_wide$edu_2018_total <- rowSums(education_wide[,17:21])
education_wide$edu_2019_total <- rowSums(education_wide[,22:26])
education_wide$edu_2020_total <- rowSums(education_wide[,27:31])

education_wide <- education_wide %>% 
  mutate(ratio_Y2015__pre_secondary = round((Y2015_pre_secondary / edu_2015_total) * 100,digits = 0),
         ratio_Y2016__pre_secondary = round((Y2016_pre_secondary / edu_2016_total) * 100,digits = 0),
         ratio_Y2017__pre_secondary = round((Y2017_pre_secondary / edu_2017_total) * 100,digits = 0),
         ratio_Y2018__pre_secondary = round((Y2018_pre_secondary / edu_2018_total) * 100,digits = 0),
         ratio_Y2019__pre_secondary = round((Y2019_pre_secondary / edu_2019_total) * 100,digits = 0),
         ratio_Y2020__pre_secondary = round((Y2020_pre_secondary / edu_2020_total) * 100,digits = 0)) %>% 
  mutate(ratio_Y2015_secondary = round((Y2015_secondary / edu_2015_total)*100, digits = 0),
         ratio_Y2016_secondary = round((Y2016_secondary / edu_2016_total)*100, digits = 0),
         ratio_Y2017_secondary = round((Y2017_secondary / edu_2017_total)*100, digits = 0),
         ratio_Y2018_secondary = round((Y2018_secondary / edu_2018_total)*100, digits = 0),
         ratio_Y2019_secondary = round((Y2019_secondary / edu_2019_total)*100, digits = 0),
         ratio_Y2020_secondary = round((Y2020_secondary / edu_2020_total)*100, digits = 0)) %>% 
  mutate(ratio_Y2015_post_sec_l3 = round((Y2015_post_sec_l3 / edu_2015_total)*100, digits = 0),
         ratio_Y2016_post_sec_l3 = round((Y2016_post_sec_l3 / edu_2016_total)*100, digits = 0),
         ratio_Y2017_post_sec_l3 = round((Y2017_post_sec_l3 / edu_2017_total)*100, digits = 0),
         ratio_Y2018_post_sec_l3 = round((Y2018_post_sec_l3 / edu_2018_total)*100, digits = 0),
         ratio_Y2019_post_sec_l3 = round((Y2019_post_sec_l3 / edu_2019_total)*100, digits = 0),
         ratio_Y2020_post_sec_l3 = round((Y2020_post_sec_l3 / edu_2020_total)*100, digits = 0)) %>% 
  mutate(ratio_Y2015__post_sec_m3 = round((Y2015_post_sec_m3 / edu_2015_total)*100, digits = 0),
         ratio_Y2016__post_sec_m3 = round((Y2016_post_sec_m3 / edu_2016_total)*100, digits = 0),
         ratio_Y2017__post_sec_m3 = round((Y2017_post_sec_m3 / edu_2017_total)*100, digits = 0),
         ratio_Y2018__post_sec_m3 = round((Y2018_post_sec_m3 / edu_2018_total)*100, digits = 0),
         ratio_Y2019__post_sec_m3 = round((Y2019_post_sec_m3 / edu_2019_total)*100, digits = 0),
         ratio_Y2020__post_sec_m3 = round((Y2020_post_sec_m3 / edu_2020_total)*100, digits = 0)) %>% 
  mutate(ratio_Y2015__info_missing = round((Y2015_info_missing / edu_2015_total)*100, digits = 0),
         ratio_Y2016__info_missing = round((Y2016_info_missing / edu_2016_total)*100, digits = 0),
         ratio_Y2017__info_missing = round((Y2017_info_missing / edu_2017_total)*100, digits = 0),
         ratio_Y2018__info_missing = round((Y2018_info_missing / edu_2018_total)*100, digits = 0),
         ratio_Y2019__info_missing = round((Y2019_info_missing / edu_2019_total)*100, digits = 0),
         ratio_Y2020__info_missing = round((Y2020_info_missing / edu_2020_total)*100, digits = 0))

education_agg <- education_wide %>% 
  left_join(regso_name_aggtdegso, by = "regso") %>% 
  select(-1) %>% 
  select(67,1:66)
education_agg <- aggregate(. ~ new_name, FUN = sum, data = education_agg)
  
education <- education_agg %>% 
  select(1,38:43,56:67) %>% 
  pivot_longer(cols = starts_with("ratio"), names_to = "education", values_to = "edu_ratio") %>% 
  separate(education, c("year","education"), sep = "__") %>% 
  separate(year, c("remove","year"), sep = "ratio_Y") %>% 
  select(-2) %>% 
  pivot_wider(names_from = "education", values_from = "edu_ratio")
  
sum(is.na(education))

education_save <- write.csv(education, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/education_save.csv", fileEncoding = "UTF-8")

edu_category <- education_ori %>% 
  filter(education != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso") %>%
  count(education) %>% 
  select(1)

```
## 4.2 *gender* (*whole population*) (process)
```{r}
gender_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/whole_population_regso_gender_2011_2020.xlsx")
colnames(gender_ori) <- c("name","gender","Y2011","Y2012","Y2013","Y2014","Y2015","Y2016","Y2017","Y2018","Y2019","Y2020")
gender_all <- gender_ori %>% 
  filter(gender != "NA") %>% 
  filter(Y2011 != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso") %>% 
  mutate(gender = case_when(gender == "mC$n" ~ "male",
                            gender == "kvinnor" ~ "female",
                            gender == "totalt" ~ "total_population")) 

# replace value 0 as the non-0 value next
gender_all$Y2013 <- ifelse(gender_all$Y2013 == 0, gender_all$Y2014, gender_all$Y2013)
gender_all$Y2012 <- ifelse(gender_all$Y2012 == 0, gender_all$Y2013, gender_all$Y2012)
gender_all$Y2011 <- ifelse(gender_all$Y2011 == 0, gender_all$Y2012, gender_all$Y2011)

gender_all <- gender_all%>% 
  pivot_wider(names_from = "gender", 
              values_from = c("Y2011","Y2012","Y2013","Y2014","Y2015","Y2016","Y2017","Y2018","Y2019","Y2020"), 
              values_fn = NULL) %>% 
  left_join(regso_name_aggtdegso, by = "regso") %>% 
  select(-1) %>% 
  select(31,1:30)

gender_all[,2:31] <- sapply(gender_all[,2:31], as.numeric)
gender_agg <- aggregate(. ~ new_name, FUN = sum, data = gender_all)

gender <- gender_agg %>% 
  pivot_longer(cols = starts_with("Y2"), names_to = "year", values_to = "population") %>% 
  separate(year, c("year","gender")) %>% 
  separate(year, c("remove", "year"), sep = "Y") %>% 
  select(-2) %>% 
  pivot_wider(names_from = "gender", values_from = "population")

whole_pop <- gender %>% 
  select(-3,-4)

whole_pop[,2:3] <- sapply(whole_pop[,2:3], as.numeric)

gender_save <- write.csv(gender, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/gender_save.csv", 
                         fileEncoding = "UTF-8") 
whole_pop_save <- write.csv(whole_pop, 
                            file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/whole_pop_save.csv",
                            fileEncoding = "UTF-8")
```
## 4.3 *birthregion* (process)
region of birth
Europe except Sweden
The Nordic countries, EU countries and the rest of Europe, including Russia and Turkey.
```{r}
birthregion_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/regso_birthregion_2010_2020.xlsx")
colnames(birthregion_ori) <- c("name","birthregion","Y2010","Y2011","Y2012","Y2013","Y2014","Y2015","Y2016","Y2017","Y2018","Y2019","Y2020")
birthregion_all <- birthregion_ori %>% 
  filter(birthregion != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso") %>%
  mutate(birthregion = case_when(birthregion == "Sverige" ~ "sweden",
                                 birthregion == "Europa utom Sverige" ~ "eu",
                                 birthregion == "C6vriga vC$rlden inkl. uppgift saknas" ~ "other_missing",
                                 birthregion == "totalt" ~ "total_birthregion"))

# replace value 0 as the non-0 value next
birthregion_all$Y2013 <- ifelse(birthregion_all$Y2013 == 0, birthregion_all$Y2014, birthregion_all$Y2013)
birthregion_all$Y2012 <- ifelse(birthregion_all$Y2012 == 0, birthregion_all$Y2013, birthregion_all$Y2012)
birthregion_all$Y2011 <- ifelse(birthregion_all$Y2011 == 0, birthregion_all$Y2012, birthregion_all$Y2011)
birthregion_all$Y2010 <- ifelse(birthregion_all$Y2010 == 0, birthregion_all$Y2011, birthregion_all$Y2010)

birthregion_wo_total <- birthregion_all %>% 
  filter(birthregion != "total_birthregion") 
colnames(birthregion_wo_total) <- c("regso","birthregion","Y2010","Y2011","Y2012","Y2013","Y2014","Y2015","Y2016","Y2017","Y2018","Y2019","Y2020")

birthregion_total <- birthregion_all %>% 
  filter(birthregion != "total_birthregion") %>%
  pivot_wider(names_from = "birthregion", 
              values_from = c("Y2010","Y2011","Y2012","Y2013","Y2014","Y2015","Y2016","Y2017","Y2018","Y2019","Y2020"))
birthregion_total[,2:34] <- sapply(birthregion_total[,2:34], as.numeric) 

birthregion_total$bregion_2010_total <- rowSums(birthregion_total[,2:4])
birthregion_total$bregion_2011_total <- rowSums(birthregion_total[,5:7])
birthregion_total$bregion_2012_total <- rowSums(birthregion_total[,8:10])
birthregion_total$bregion_2013_total <- rowSums(birthregion_total[,11:13])
birthregion_total$bregion_2014_total <- rowSums(birthregion_total[,14:16])
birthregion_total$bregion_2015_total <- rowSums(birthregion_total[,17:19])
birthregion_total$bregion_2016_total <- rowSums(birthregion_total[,20:22])
birthregion_total$bregion_2017_total <- rowSums(birthregion_total[,23:25])
birthregion_total$bregion_2018_total <- rowSums(birthregion_total[,26:28])
birthregion_total$bregion_2019_total <- rowSums(birthregion_total[,29:31])
birthregion_total$bregion_2020_total <- rowSums(birthregion_total[,32:34])  

birthregion_ratio <- birthregion_total %>% 
  mutate(ratio_Y2010__sweden = round((Y2010_sweden / bregion_2010_total) * 100,digits = 0),
         ratio_Y2011__sweden = round((Y2011_sweden / bregion_2011_total) * 100,digits = 0),
         ratio_Y2012__sweden = round((Y2012_sweden / bregion_2012_total) * 100,digits = 0),
         ratio_Y2013__sweden = round((Y2013_sweden / bregion_2013_total) * 100,digits = 0),
         ratio_Y2014__sweden = round((Y2014_sweden / bregion_2014_total) * 100,digits = 0),
         ratio_Y2015__sweden = round((Y2015_sweden / bregion_2015_total) * 100,digits = 0),
         ratio_Y2016__sweden = round((Y2016_sweden / bregion_2016_total) * 100,digits = 0),
         ratio_Y2017__sweden = round((Y2017_sweden / bregion_2017_total) * 100,digits = 0),
         ratio_Y2018__sweden = round((Y2019_sweden / bregion_2018_total) * 100,digits = 0),
         ratio_Y2019__sweden = round((Y2019_sweden / bregion_2019_total) * 100,digits = 0),
         ratio_Y2020__sweden = round((Y2020_sweden / bregion_2020_total) * 100,digits = 0)) %>% 
  mutate(ratio_Y2010__eu = round((Y2010_eu / bregion_2010_total)*100, digits = 0),
         ratio_Y2011__eu = round((Y2011_eu / bregion_2011_total)*100, digits = 0),
         ratio_Y2012__eu = round((Y2012_eu / bregion_2012_total)*100, digits = 0),
         ratio_Y2013__eu = round((Y2013_eu / bregion_2013_total)*100, digits = 0),
         ratio_Y2014__eu = round((Y2014_eu / bregion_2014_total)*100, digits = 0),
         ratio_Y2015__eu = round((Y2015_eu / bregion_2015_total)*100, digits = 0),
         ratio_Y2016__eu = round((Y2016_eu / bregion_2016_total)*100, digits = 0),
         ratio_Y2017__eu = round((Y2017_eu / bregion_2017_total)*100, digits = 0),
         ratio_Y2018__eu = round((Y2018_eu / bregion_2018_total)*100, digits = 0),
         ratio_Y2019__eu = round((Y2019_eu / bregion_2019_total)*100, digits = 0),
         ratio_Y2020__eu = round((Y2020_eu / bregion_2020_total)*100, digits = 0)) %>% 
  mutate(ratio_Y2010__other_missing = round((Y2010_other_missing / bregion_2010_total)*100, digits = 0),
         ratio_Y2011__other_missing = round((Y2011_other_missing / bregion_2011_total)*100, digits = 0),
         ratio_Y2012__other_missing = round((Y2012_other_missing / bregion_2012_total)*100, digits = 0),
         ratio_Y2013__other_missing = round((Y2013_other_missing / bregion_2013_total)*100, digits = 0),
         ratio_Y2014__other_missing = round((Y2014_other_missing / bregion_2014_total)*100, digits = 0),
         ratio_Y2015__other_missing = round((Y2015_other_missing / bregion_2015_total)*100, digits = 0),
         ratio_Y2016__other_missing = round((Y2016_other_missing / bregion_2016_total)*100, digits = 0),
         ratio_Y2017__other_missing = round((Y2017_other_missing / bregion_2017_total)*100, digits = 0),
         ratio_Y2018__other_missing = round((Y2018_other_missing / bregion_2018_total)*100, digits = 0),
         ratio_Y2019__other_missing = round((Y2019_other_missing / bregion_2019_total)*100, digits = 0),
         ratio_Y2020__other_missing = round((Y2020_other_missing / bregion_2020_total)*100, digits = 0))  
  
birthregion_ratio[which(is.na(birthregion_ratio$ratio_Y2010__other_missing)),]


birthregion_agg <- birthregion_ratio %>% 
  left_join(regso_name_aggtdegso, by = "regso") %>% 
  select(-1) %>% 
  select(78,1:77)

birthregion_agg <- aggregate(. ~ new_name, FUN = sum, data = birthregion_agg)

birthregion <- birthregion_agg %>% 
  select(c(1,46:78)) %>% 
  pivot_longer(cols = starts_with("ra"),
               names_to = "year", 
               values_to = "birthregion_ratio") %>% 
  separate(col = year, into = c("year", "brithregion"), sep = "__") %>% 
  separate(year, c("remove", "year"), "Y") %>% 
  select(-2) %>% 
  pivot_wider(names_from = "brithregion", values_from = "birthregion_ratio")

sum(is.na(birthregion_ratio))

birthregion_save <- write.csv(birthregion, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/birthregion_save.csv", fileEncoding = "UTF-8")


birthregion_category <- birthregion_ori %>% 
  filter(birthregion != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso") %>%
  count(birthregion) %>% 
  select(1)
```
## 4.4 *household type* (process)
```{r}
# household type data 2011--2013
householdtype_2011_2013_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/householdtype_2011_2013.xlsx")

colnames(householdtype_2011_2013_ori) <- c("name","householdtype","Y2011","Y2012","Y2013")

householdtype_2011_2013 <- householdtype_2011_2013_ori %>% 
  filter(householdtype != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso")

# #household type data 2014--2020
householdtype_2014_2020_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/householdtype_2014_2020.xlsx")

colnames(householdtype_2014_2020_ori) <- c("name","householdtype","Y2014","Y2015","Y2016","Y2017","Y2018","Y2019","Y2020")

householdtype_2014_2020 <- householdtype_2014_2020_ori %>% 
  filter(householdtype != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso")

# combine dataset
householdtype_bind <- householdtype_2011_2013 %>% 
  cbind(householdtype_2014_2020) %>% 
  select(-6,-7)

householdtype_total <- householdtype_bind %>% 
  filter(householdtype == "totalt antal hushC%ll") %>% 
  select(-2)
colnames(householdtype_total) <- c("regso", "T2011","T2012","T2013","T2014","T2015","T2016","T2017","T2018","T2019","T2020")

householdtype_column_total <- householdtype_bind %>% 
  filter(householdtype != "totalt antal hushC%ll") %>% 
  left_join(householdtype_total, by = "regso")

householdtype_column_total[,3:22] <- sapply(householdtype_column_total[,3:22], as.numeric)

householdtype_column_total[householdtype_column_total == 0] <- NA

householdtype_column_total[c(which(is.na(householdtype_column_total$T2011))),]

householdtype_column_total$Y2013 <- ifelse(is.na(householdtype_column_total$Y2013), householdtype_column_total$Y2014, householdtype_column_total$Y2013)
householdtype_column_total$Y2012 <- ifelse(is.na(householdtype_column_total$Y2012), householdtype_column_total$Y2013, householdtype_column_total$Y2012)
householdtype_column_total$Y2011 <- ifelse(is.na(householdtype_column_total$Y2011), householdtype_column_total$Y2012, householdtype_column_total$Y2011)

householdtype_column_total$T2013 <- ifelse(is.na(householdtype_column_total$T2013), householdtype_column_total$T2014, householdtype_column_total$T2013)
householdtype_column_total$T2012 <- ifelse(is.na(householdtype_column_total$T2012), householdtype_column_total$T2013, householdtype_column_total$T2012)
householdtype_column_total$T2011 <- ifelse(is.na(householdtype_column_total$T2011), householdtype_column_total$T2012, householdtype_column_total$T2011)

sum(is.na(householdtype_column_total)) 

#householdtype_column_total[,3:22] <- na.locf(householdtype_column_total[,3:22], na.rm = F, fromLast = TRUE)

householdtype_ratio <- householdtype_column_total %>% 
  mutate(R2011 = round(Y2011 / T2011 * 100, 0),
         R2012 = round(Y2012 / T2012 * 100, 0),
         R2013 = round(Y2013 / T2013 * 100, 0),
         R2014 = round(Y2014 / T2014 * 100, 0),
         R2015 = round(Y2015 / T2015 * 100, 0),
         R2016 = round(Y2016 / T2016 * 100, 0),
         R2017 = round(Y2017 / T2017 * 100, 0),
         R2018 = round(Y2018 / T2018 * 100, 0),
         R2019 = round(Y2019 / T2019 * 100, 0),
         R2020 = round(Y2020 / T2020 * 100, 0))

householdtype_agg <- householdtype_ratio %>% 
  select(1,2,23:32) %>% 
  pivot_wider(names_from = "householdtype", 
              values_from = c("R2011","R2012","R2013","R2014","R2015","R2016","R2017","R2018","R2019","R2020")) %>% 
  left_join(regso_name_aggtdegso, by = "regso") %>% 
  select(-1) %>% 
  select(51, 1:50)
  
householdtype_agg <- aggregate(. ~ new_name, sum, data = householdtype_agg)

householdtype <- householdtype_agg %>%  
  pivot_longer(cols = starts_with("R20"),
               names_to = "year", 
               values_to = "householdtype_ratio") %>% 
  separate(year, c("year","householdtype"), sep = "_") %>% 
  mutate(householdtype = case_when(householdtype == "sammanboende med barn" ~ "colive_w_child",
                                   householdtype == "sammanboende utan barn" ~ "colive_wo_child",
                                   householdtype == "ensamstC%ende med barn" ~ "alone_w_child",
                                   householdtype == "ensamstC%ende utan barn" ~ "alone_wo_child",
                                   householdtype == "C6vriga hushC%ll" ~ "other")) %>% 
  separate(year, c("remove","year"), sep = "R") %>% 
  select(-2) %>% 
  pivot_wider(names_from = "householdtype", values_from = "householdtype_ratio")

sum(is.na(householdtype)) 

householdtype_save <- write.csv(householdtype, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/householdtype_save.csv", fileEncoding = "UTF-8")

householdtype_category <- householdtype_2014_2020_ori %>% 
  filter(householdtype != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso") %>%
  count(householdtype) %>% 
  select(1)
```
## 4.5 *high_low_economic_standard* (process)
```{r}
economic_standard_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/low_high_economic_standard_2011_2020.xlsx")
colnames(economic_standard_ori) <- c("name",
                                    "Y2011__low_ecos","Y2012__low_ecos","Y2013__low_ecos","Y2014__low_ecos","Y2015__low_ecos","Y2016__low_ecos","Y2017__low_ecos","Y2018__low_ecos","Y2019__low_ecos","Y2020__low_ecos",
                                    "Y2011__high_ecos","Y2012__high_ecos","Y2013__high_ecos","Y2014__high_ecos","Y2015__high_ecos","Y2016__high_ecos","Y2017__high_ecos","Y2018__high_ecos","Y2019__high_ecos","Y2020__high_ecos",
                                    "Y2011_total_ecos","Y2012_total_ecos","Y2013_total_ecos","Y2014_total_ecos","Y2015_total_ecos","Y2016_total_ecos","Y2017_total_ecos","Y2018_total_ecos","Y2019_total_ecos","Y2020_total_ecos" )

economic_standard_all <- economic_standard_ori %>%
  filter(name != "NA") %>%
  filter(Y2011__low_ecos != "NA") %>%
  separate(name, c("kommun", "regso"), sep = "[(]") %>%
  separate(regso, c("regso", "remove"), sep = "[)]") %>%
  select(c(-1, -3)) %>%
  right_join(regso_aggname_only, by = "regso")
economic_standard_all <- economic_standard_all[!grepl("[,]", economic_standard_all$Y2011__low_ecos),]

economic_standard_agg <- economic_standard_all %>% 
  left_join(regso_name_aggtdegso, by = "regso") %>% 
  select(-1) %>% 
  select(31, 1:20)

economic_standard_agg[,2:21] <- sapply(economic_standard_agg[,2:21], as.numeric)

# which(is.na(economic_standard_agg$Y2011__high_ecos))
 economic_standard_agg[c(48,391,392,399),]

economic_standard_agg$Y2011__low_ecos <- ifelse(is.na(economic_standard_agg$Y2011__low_ecos), economic_standard_agg$Y2012__low_ecos, economic_standard_agg$Y2011__low_ecos)
economic_standard_agg$Y2012__low_ecos <- ifelse(is.na(economic_standard_agg$Y2012__low_ecos), economic_standard_agg$Y2013__low_ecos, economic_standard_agg$Y2012__low_ecos)
economic_standard_agg$Y2013__low_ecos <- ifelse(is.na(economic_standard_agg$Y2013__low_ecos), economic_standard_agg$Y2014__low_ecos, economic_standard_agg$Y2013__low_ecos)
economic_standard_agg$Y2012__low_ecos <- ifelse(is.na(economic_standard_agg$Y2012__low_ecos), economic_standard_agg$Y2013__low_ecos, economic_standard_agg$Y2012__low_ecos)
economic_standard_agg$Y2011__low_ecos <- ifelse(is.na(economic_standard_agg$Y2011__low_ecos), economic_standard_agg$Y2012__low_ecos, economic_standard_agg$Y2011__low_ecos)

economic_standard_agg$Y2011__high_ecos <- ifelse(is.na(economic_standard_agg$Y2011__high_ecos), economic_standard_agg$Y2012__high_ecos, economic_standard_agg$Y2011__high_ecos)
economic_standard_agg$Y2012__high_ecos <- ifelse(is.na(economic_standard_agg$Y2012__high_ecos), economic_standard_agg$Y2013__high_ecos, economic_standard_agg$Y2012__high_ecos)
economic_standard_agg$Y2013__high_ecos <- ifelse(is.na(economic_standard_agg$Y2013__high_ecos), economic_standard_agg$Y2014__high_ecos, economic_standard_agg$Y2013__high_ecos)
economic_standard_agg$Y2012__high_ecos <- ifelse(is.na(economic_standard_agg$Y2012__high_ecos), economic_standard_agg$Y2013__high_ecos, economic_standard_agg$Y2012__high_ecos)
economic_standard_agg$Y2011__high_ecos <- ifelse(is.na(economic_standard_agg$Y2011__high_ecos), economic_standard_agg$Y2012__high_ecos, economic_standard_agg$Y2011__high_ecos)
 
economic_standard_agg <- aggregate(. ~ new_name, sum, data = economic_standard_agg)

economic_standard <- economic_standard_agg%>% 
  select(1:21) %>% 
  pivot_longer(cols = starts_with("Y2"), names_to = "year", values_to = "ecos_ratio") %>% 
  separate(year, c("year", "economic_standard"),"__") %>% 
  separate(year, c("remove", "year"), sep = "Y") %>% 
  select((-2)) %>% 
  pivot_wider(names_from = "economic_standard", values_from = "ecos_ratio")

sum(is.na(economic_standard_agg))

economic_standard_save <- write.csv(economic_standard, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/economic_standard_save.csv", fileEncoding = "UTF-8")
```
## 4.6 *age* (process)
```{r}
age_1112_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/age_2011_2012.xlsx")
colnames(age_1112_ori) <- c("name","age_range","Y2011","Y2012")

age_1112 <- age_1112_ori %>% 
  filter(age_range != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso")

age_1314_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/age_2013_2014.xlsx")
colnames(age_1314_ori) <- c("name","age_range","Y2013","Y2014")

age_1314 <- age_1314_ori %>% 
  filter(age_range != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso")

age_1516_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/age_2015_2016.xlsx")
colnames(age_1516_ori) <- c("name","age_range","Y2015","Y2016")

age_1516 <- age_1516_ori %>% 
  filter(age_range != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso")

age_1718_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/age_2017_2018.xlsx")
colnames(age_1718_ori) <- c("name","age_range","Y2017","Y2018")

age_1718 <- age_1718_ori %>% 
  filter(age_range != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso")

age_1920_ori <- read_xlsx(path = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/age_2019_2020.xlsx")
colnames(age_1920_ori) <- c("name","age_range","Y2019","Y2020")

age_1920 <- age_1920_ori %>% 
  filter(age_range != "NA") %>% 
  fill(name, .direction = "down") %>% 
  separate(name, c("kommun", "regso"), sep = "[(]") %>% 
  separate(regso, c("regso", "remove"), sep = "[)]") %>% 
  select(c(-1, -3)) %>% 
  right_join(regso_aggname_only, by = "regso")

age_all <- age_1112 %>% 
  cbind(age_1314, age_1516, age_1718, age_1920) %>% 
  select(-5,-6,-9,-10,-13,-14,-17,-18) %>% 
  right_join(regso_aggname_only, by = "regso")

# replace value 0 as the non-0 value next
age_all$Y2013 <- ifelse(age_all$Y2013 == 0, age_all$Y2014, age_all$Y2013)
age_all$Y2012 <- ifelse(age_all$Y2012 == 0, age_all$Y2013, age_all$Y2012)
age_all$Y2011 <- ifelse(age_all$Y2011 == 0, age_all$Y2012, age_all$Y2011)

age_all <- age_all %>% 
  pivot_wider(names_from = "age_range",
              values_from = c("Y2011","Y2012","Y2013","Y2014","Y2015","Y2016","Y2017","Y2018","Y2019","Y2020")) %>% 
  left_join(regso_name_aggtdegso, by = "regso") %>% 
  select(-1) %>% 
  select(181, 1:180)

age_all[,2:181] <- sapply(age_all[,2:181], as.numeric)
age_agg <- aggregate(. ~ new_name, FUN = sum, data = age_all)

age <- age_agg %>% 
  pivot_longer(cols = starts_with("Y2"), names_to = "year", values_to = "population") %>% 
  separate(year, c("year","age"), sep = "_") %>% 
  separate(year, c("remove", "year"), sep = "Y") %>% 
  select(-2) %>% 
  pivot_wider(names_from = "age", values_from = "population")

sum(is.na(age_all)) 
age$young <- rowSums(age[,c(7,8,9)]) # "15-19 C%r" "20-24 C%r" "25-29 C%r"
age$old <- rowSums(age[,c(17,18,19,20)]) # "65-69 C%r" "70-74 C%r" "75-79 C%r" "80- C%r"
age_young_old <- age %>% 
  mutate(young_ratio = round(young / totalt, 2) * 100,
         old_ratio = round(old / totalt, 2) * 100) %>% 
  select(1,2,23,24)
age_young_old_save <-  write.csv(age_young_old, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/age_young_old_save.csv",
                                 fileEncoding = "UTF-8")

age_save <- write.csv(age, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/age_save.csv", fileEncoding = "UTF-8")

age_category <- age_all %>% 
  select(c(1, 2)) %>% 
  count(age_range, sort = F) %>% 
  select(1)
```
## 4.7 *import all variables (run)*
```{r}
# education
education <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/education_save.csv", encoding = "UTF-8") %>% 
  select(-1)
# birthregion
birthregion <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/birthregion_save.csv", encoding = "UTF-8") %>% 
  filter(year != 2010) %>% 
  select(-1)
# householdtype
householdtype <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/householdtype_save.csv", encoding = "UTF-8") %>% 
  select(-1)
# economic standard
economic_standard <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/economic_standard_save.csv", encoding = "UTF-8") %>% 
  select(-1)
# gender
gender <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/gender_save.csv",
                   encoding = "UTF-8")
# whole polulation
whole_pop <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/whole_pop_save.csv", encoding = "UTF-8") %>% 
  select(-1)
# age
age <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/age_young_old_save.csv", encoding = "UTF-8") %>% 
  select(-1)
```

# 5. Combine topics and calculate mean probability for each selected topic
```{r}
name_prop_topic_agg <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/Topic modelling/all_post_LDA/name_prop_topic_agg.csv", encoding = "UTF-8") %>% 
  select(-1)
name_prop_topic_agg_select <- name_prop_topic_agg 
# high status
name_prop_topic_agg_select$high_status <- rowSums(name_prop_topic_agg_select[,c("meant10","meant36")])
# crime
name_prop_topic_agg_select$crime <- rowSums(name_prop_topic_agg_select[,c("meant2","meant7","meant12","meant13",
                                                                    "meant14","meant17","meant20", "meant29","meant30",
                                                                    "meant31","meant32","meant35")])
# immigrant
name_prop_topic_agg_select$immigrant <- rowSums(name_prop_topic_agg_select[,c("meant1","meant27")])

# housing queue
name_prop_topic_agg_select$housing_queue <- name_prop_topic_agg_select$meant28

name_prop_topic_agg_select <- name_prop_topic_agg_select %>% 
  select(1,47:50)

name_prop_topic_agg_select$rowsum <- rowSums(name_prop_topic_agg_select[,2:5])

# standardize the probability of each neighborhood on the 4 topics (i.e., topic scores)
name_prop_topic_agg_select[,2:5] <- name_prop_topic_agg_select[,2:5]/name_prop_topic_agg_select[,6] * 100

name_prop_topic_agg_select_save <- write.csv(name_prop_topic_agg_select, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/Topic modelling/all_post_LDA/name_prop_topic_agg_select_save.csv", fileEncoding = "UTF-8")

# just check if the sum of row = 1
rowSums(name_prop_topic_agg_select[10,2:5])

# mena center topic scores
center_apply <- function(x) {
    apply(x, 2, function(y) y - mean(y))
}

name_prop_topic_agg_select_center <- name_prop_topic_agg_select
name_prop_topic_agg_select_center[,2:5] <- center_apply(name_prop_topic_agg_select_center[,2:5])
```
## 5.1 Average probability for each topic table (i.e., topic scores)
Table 3.  Mean probability of topics 
```{r}
mean_pro_topic <- name_prop_topic_agg_select %>% 
  select(-1,-6)
mean_pro_topic[,1:4] <- sapply(mean_pro_topic[,1:4], as.numeric)
mean_pro_topic <- as.data.frame(colMeans(mean_pro_topic))
mean_pro_topic <- tibble::rownames_to_column(mean_pro_topic, "Topic")
colnames(mean_pro_topic) <- c("Topic","Mean probability")
mean_pro_topic$Topic <- c("High status","Crime","Immigrant","Housing queue")
rownames(mean_pro_topic)<-NULL
mean_pro_topic_table <- knitr::kable(mean_pro_topic, align = "lc", digits = 2,
                             format.args = list(big.mark = ",", scientific = FALSE),
                             #caption = "Table 1 Descriptive statistics",
                             booktabs = T) %>% 
  kable_classic(full_width = F, html_font = "Cambria") %>% 
  kable_styling(latex_options = "hold_position") %>% 
  kableExtra::footnote(general = "Souce: LDA model, author's calculation",
           fixed_small_size = TRUE, 
           footnote_as_chunk = TRUE, 
           threeparttable = F) 
mean_pro_topic_table
```

# 6. Combine neighborhood demographics with topic scores
## 6.1 Combine demographic data 229 names, 229 of 473 RegSO names are mentioned on Flashback (process) *whole Stockholm county*
```{r}
demographic_11_20 <- whole_pop %>% 
  left_join(birthregion, by = c("new_name", "year")) %>%
  left_join(age, by = c("new_name", "year")) %>%
  left_join(householdtype, by = c("new_name", "year")) %>%
  left_join(economic_standard, by = c("new_name", "year")) %>% 
  right_join(name_prop_topic_agg_select, by = "new_name")
  #left_join(name_prop_topic_agg, by = "new_name") 
demographic_11_20[is.na(demographic_11_20)] <- 0
write.csv(demographic_11_20, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/demographic_11_20_save.csv", fileEncoding = "UTF-8")

# Education variable is available from 2015 to 2020
demographic_15_20 <- education %>% 
  left_join(whole_pop, by = c("new_name", "year")) %>%
  left_join(birthregion, by = c("new_name", "year")) %>%
  left_join(age, by = c("new_name", "year")) %>%
  left_join(householdtype, by = c("new_name", "year")) %>%
  left_join(economic_standard, by = c("new_name", "year")) %>% 
  right_join(name_prop_topic_agg_select, by = "new_name")
  #left_join(name_prop_topic_agg, by = "new_name") 
demographic_15_20[is.na(demographic_15_20)] <- 0
write.csv(demographic_15_20, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/demographic_15_20_save.csv", fileEncoding = "UTF-8")

# I pick year 2020 for maps and bivariate correlation tables. The total number of mentions reach to a peak in 2020 and 2013. I want to add education variable. So I use the demographics data in 2020
demographic_2020 <- demographic_15_20 %>% 
  filter(year == 2020)
column_nams <- c("new_name", "year", "Pre-secondary","3+ post-secondary","Education information missing","Total population",
                 "Born in Sweden","Born in EU","Born in other country","Age 15-29","Age > 65","Cohabitation, with children","Cohabitation, without children",
                 "Single, with children","Single, without children","Other household type","Low economic standard","High economic standard",
                 "Topic: high status","Topic: crime","Topic: immigrant","Topic: housing queue")

colnames(demographic_2020) <- column_nams

## Import demographic data 229 *whole stockholm county*
demographic_11_20 <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/demographic_11_20_save.csv", encoding = "UTF-8") %>% 
  select(-1)

demographic_15_20 <- read.csv(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/demographic_15_20_save.csv", encoding = "UTF-8") %>% 
  select(-1)
```
## 6.2 Combine demographic data 97 names (process) *Stockholm municipality*
```{r}
demographic_11_20_stkh <- whole_pop %>% 
  left_join(birthregion, by = c("new_name", "year")) %>%
  left_join(age, by = c("new_name", "year")) %>%
  left_join(householdtype, by = c("new_name", "year")) %>%
  left_join(economic_standard, by = c("new_name", "year")) %>% 
  right_join(name_prop_topic_agg_select_center, by = "new_name")
  #left_join(name_prop_topic_agg, by = "new_name") 
demographic_11_20_stkh[is.na(demographic_11_20_stkh)] <- 0
write.csv(demographic_11_20_stkh, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/demographic_11_20_stkh_save.csv", fileEncoding = "UTF-8")

demographic_15_20_stkh <- education %>% 
  left_join(whole_pop, by = c("new_name", "year")) %>%
  left_join(birthregion, by = c("new_name", "year")) %>%
  left_join(age, by = c("new_name", "year")) %>%
  left_join(householdtype, by = c("new_name", "year")) %>%
  left_join(economic_standard, by = c("new_name", "year")) %>% 
  right_join(name_prop_topic_agg_select_center, by = "new_name")
  #left_join(name_prop_topic_agg, by = "new_name") 
demographic_15_20_stkh[is.na(demographic_15_20_stkh)] <- 0
write.csv(demographic_15_20_stkh, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/demographic_15_20_stkh_save.csv", fileEncoding = "UTF-8")

demographic_2020_stkh <- demographic_15_20_stkh %>% 
  filter(year == 2020)
```

# 7. Independent variables descriptive statistics
Table 1.2. Descriptive statistics for demographic variables for RegSO from 2020
```{r}
library(psych)
var_des <- as.data.frame(describe(demographic_2020[,3:18])) %>%
  select(3,4,5,8,9)
var_des <- tibble::rownames_to_column(var_des, "Variable")
var_des <- as.data.frame(var_des)
colnames(var_des) <- c("Variable","Mean","SD","Median","Min","Max")
knitr::kable(var_des, digits = 0, booktab = T) %>% 
               #caption = "Table ? Demographic variable description") %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(latex_options = "hold_position") %>% 
  pack_rows("Education", 1, 3) %>%
  pack_rows("Population", 4,4) %>% 
  pack_rows("Birthregion", 5, 7) %>%
  pack_rows("Age",8,9) %>%
  pack_rows("Household type", 10, 14) %>%
  pack_rows("Economic standard", 15,16) %>%
  footnote("Source: Statistics Sweden (SCB)",
           "The category 'Born in other country' include birth region information missing.")
```
## 7.1 variables categories
Table 1.1. Demographic variables for RegSO from 2010 to 2020
```{r}
# variable categories
var_catogory <- read.delim(file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/variables_catogories.txt",
                         encoding = "UTF-8")
colnames(var_catogory) <- c("Variable", "Available year", "Category (Swedish)", "Category (English)")
options(knitr.kable.NA = '')

var_catogory_table <- knitr::kable(var_catogory[,2:4]) %>% 
               #caption = "Table ? Demographic variable description") %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(latex_options = "hold_position") %>% 
  pack_rows("Education", 1, 5) %>%
  pack_rows("Birthregion", 6, 8) %>% 
  pack_rows("Household type", 9, 13) %>% 
  pack_rows("Economic standard", 14,15) %>% 
  pack_rows("Age",16,31) %>% 
  footnote(general = "Source: Statistics Sweden (SCB)",
           number = c("Footnote 1. Low economic standard refers to the proportion of people living in households whose economic standard is less than 60 per cent of the median value for the country.", 
                      "Footnote 2. High economic standard refers to the proportion of people living in households whose economic standard is twice as high as the median value for the country.")) 
```
# 8. Correlation table. *bivariate associations* 
```{r}
# correlation table
demographic_2020 <- demographic_15_20 %>% 
  filter(year == 2020)

column_nams2 <- c("new_name", "year", "Edu low","Edu high","Edu miss","Total popu",
                 "Sweden","EU","Non-EU","15-29",">65","colive child","Colive no child",
                 "Single child","Single no child","Other household","Low eco","High eco",
                 "Topic: high status","Topic: crime","Topic: immigrant","Topic: housing queue")

colnames(demographic_2020) <- column_nams
library(corrplot)
variable_corr <- correlate(demographic_2020[,3:22], method = c("pearson"))
```
## 8.1 Save correltion plot
```{r}
png(height=1500, width=1500, file="correlation_plot.png", type = "cairo")
corrplot(variable_corr, method="circle", type="upper", order="original", tl.col="black", tl.srt=60, tl.cex = 2.5, cl.cex = 2.5,
         cl.pos = "r")
dev.off()
```

####### Poisson Model #######
# 9. Poisson model
## 9.1 Combine demographic data 473 names for poisson regression
```{r}
demographic_df_count_1120 <- whole_pop %>%
  left_join(birthregion, by = c("new_name", "year")) %>%
  left_join(age, by = c("new_name", "year")) %>%
  left_join(householdtype, by = c("new_name", "year")) %>%
  left_join(economic_standard, by = c("new_name", "year")) %>% 
  left_join(aggregate_new_name_count_year, by = c("new_name" = "regso", "year" = "year_mention"))

demographic_df_count_1120[is.na(demographic_df_count_1120)] <- 0
write.csv(demographic_df_count_1120, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/demographic_df_count_1120.csv", fileEncoding = "UTF-8")

demographic_df_count_1520 <- education %>% 
  left_join(whole_pop, by = c("new_name", "year")) %>%
  left_join(birthregion, by = c("new_name", "year")) %>%
  left_join(age, by = c("new_name", "year")) %>%
  left_join(householdtype, by = c("new_name", "year")) %>%
  left_join(economic_standard, by = c("new_name", "year")) %>%
  left_join(aggregate_new_name_count_year, by = c("new_name" = "regso", "year" = "year_mention"))

demographic_df_count_1520[is.na(demographic_df_count_1520)] <- 0
write.csv(demographic_df_count_1520, file = "D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/SCB-demographic data/demographic_df_count_1520.csv", fileEncoding = "UTF-8")

```
## 9.2 Run poisson regression
## Table 4. Poisson regression on neighborhood mentions time by year
```{r}
poisson_count_1120 = glm(mention_time ~ factor(year) + log(total) + eu + other_missing + 
                   young_ratio + old_ratio + colive_wo_child + alone_w_child + alone_wo_child + other + 
                   low_ecos + high_ecos,
                 family = poisson, data = demographic_df_count_1120)


poisson_count_1520 = glm(mention_time ~ factor(year) + log(total) + pre_secondary + post_sec_m3 + info_missing + eu + other_missing + 
                   young_ratio + old_ratio + colive_wo_child + alone_w_child + alone_wo_child + other + 
                   low_ecos + high_ecos,
                 family = poisson, data = demographic_df_count_1520)

covariate_labels <- c("Year 2012 (Ref: Year 2011)",
                      "Year 2013",
                      "Year 2014",
                      "Year 2015",
                      "Year 2016",
                      "Year 2017",
                      "Year 2018",
                      "Year 2019",
                      "Year 2020",
                      "Log total population",
                      "pre-secondary (Ref: other education level)",
                      "3+ years post-secondary",
                      "Education information missing",
                      "Born in EU (Ref: Sweden)",
                      "Born in other country",
                      "Age 15-29",
                      "Age >= 65",
                      "Cohabitaion, without children (Ref: Cohabitaion, with children)",
                      "Single, with children",
               "Single, without children",
               "Other househould type",
               "Low economic standard",
               "High economic standard",
               "Constant")

poisson_count_year <- stargazer(poisson_count_1120,poisson_count_1520, header = F, type = "latex",
#title = "Poisson regression on neighborhoods' mention time by year with each neighborhood",
notes = c("Source: Flashback posts, author's calculation",
          "Non-EU residents include non-EU residents and missing information",
          "Low economic standard refers to the proportion of people living in",
          "households whose economic standard is less than 60 per cent of the",
          "median value for the country.",
          "High economic standard refers to the proportion of people living in",
          "households whose economic standard is twice as high as the median",
          "value for the country."),
notes.align = "l",
model.names = FALSE,
#float.env ="sidewaystable",
dep.var.labels.include = FALSE,
column.labels=c("Mention time"),
column.separate = c(2),
column.sep.width = "0.1pt",
#single.row = TRUE,
no.space = TRUE,
font.size = "scriptsize",
covariate.labels = covariate_labels)
```

####### Map #######
# 10. Map
## 10.1 Import shapefile
```{r}
#import shapefile
library(sf)
deso_geo <- st_read("D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/GIS data/deso_2018_2021-10-21/DeSO_2018_v2.gpkg")
regso_geo <- st_read("D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/GIS data/regso_2018_v1_20211103/RegSO_2018_v1.gpkg")

# Top 5 neighborhoods with low and high economic standard
lowe_high_ecos_2020 <- economic_standard %>% 
  filter(year == 2020) %>% 
  left_join(regso_name_aggtdegso, by = "new_name") 

otherbirthregion_2020 <- birthregion %>% 
  filter(year == 2020) %>% 
  left_join(regso_name_aggtdegso, by = "new_name")
colnames(otherbirthregion_2020) <- c("new_name","year","sweden","eu","nonEU","regso")

low_missing_edu_2020 <- education %>% 
  filter(year == 2020) %>% 
  left_join(regso_name_aggtdegso, by = "new_name")
colnames(low_missing_edu_2020) <- c("new_name","year","pre_secondary","post_secondary_3","edu info missing","regso")
```
## 10.2 Well-known names from demographics.
Stockholm County shape does not include river. The map might not be recognizable. So I mark some neighborhood names on maps.
```{r}
t10_mentions <- aggregate_new_name_count %>%
  slice_max(n, n = 10) %>%
  mutate(top_mention_name = regso) %>%
  select(1,3) %>%
  left_join(regso_name_aggtdegso, by = "regso") %>%
  select(2,3)
colnames(t10_mentions) <- c("regso","top_mentions")

t3_loweco <- lowe_high_ecos_2020 %>% 
  left_join(regso_new_aggtcount_ori, by = "new_name") %>% 
  filter(municipality == "Stockholm") %>% 
  slice_max(low_ecos, n = 4) %>% 
  mutate(top = new_name) %>% 
  select(1,8)

t3_higheco <- lowe_high_ecos_2020 %>% 
  left_join(regso_new_aggtcount_ori, by = "new_name") %>% 
  filter(municipality == "Stockholm") %>% 
  slice_max(high_ecos, n = 2) %>% 
  mutate(top = new_name) %>% 
  select(1,8)

t3_noneu <- otherbirthregion_2020 %>% 
  left_join(regso_new_aggtcount_ori, by = "new_name") %>% 
  filter(municipality == "Stockholm") %>% 
  slice_max(nonEU, n = 3) %>% 
  mutate(top = new_name) %>% 
  select(1,9)

t3_highedu <- low_missing_edu_2020 %>% 
  left_join(regso_new_aggtcount_ori, by = "new_name") %>% 
  filter(municipality == "Stockholm") %>% 
  slice_max(pre_secondary, n = 2) %>% 
  mutate(top = new_name) %>% 
  select(1,9)

t3_lowedu <- low_missing_edu_2020 %>% 
  left_join(regso_new_aggtcount_ori, by = "new_name") %>% 
  filter(municipality == "Stockholm") %>% 
  slice_max(post_secondary_3, n = 4) %>% 
  mutate(top = new_name) %>% 
  select(1,9)

t12_top_topic <- unique(rbind(t3_loweco, t3_higheco, t3_noneu, t3_highedu,t3_lowedu))
t12_top_topic <- t12_top_topic[-5,]
```
## 10.3 topic map data
```{r}
mulicipalities <- read.csv("D:/Nutstore no sync files/233-LIU/233.15-Master Thesis/Neighborhood names/municipalities_in_Stockholm_county.csv",
                           encoding = "UTF-8")
colnames(mulicipalities) <- c("number","municipality")

# combine dataset "mulicipalities" and reso_geo filtering Stockholm county
regso_geo_Stkh <- regso_geo %>% 
  filter(kommunnamn %in% mulicipalities$municipality)

# topic probability
regso_topic_map <- name_prop_topic_agg_select_center %>% 
  left_join(aggregate_new_name_count, by = c("new_name" = "regso")) %>% 
  left_join(regso_name_aggtdegso, by = "new_name") %>% 
  left_join(lowe_high_ecos_2020[,c(1,3,4)], by = "new_name") %>% 
  #left_join(higheco_t15[,c(1,5)], by = "new_name") %>% 
  left_join(otherbirthregion_2020[,c(1,3,4,5)], by = "new_name") %>%
  left_join(low_missing_edu_2020[,c(1,3,4,5)], by = "new_name") %>% 
  #left_join(t10_mentions, by = "new_name") %>% 
  left_join(t12_top_topic, by = "new_name") %>% 
  right_join(regso_geo_Stkh, by = "regso") %>% 
  #left_join(stkh_neighborhood, by = "regso") %>% 
  st_as_sf() %>% 
  unique(.)

regso_topic_map$n <- log(regso_topic_map$n)

names(regso_topic_map)[names(regso_topic_map) == "high_status"] <- "high status"
names(regso_topic_map)[names(regso_topic_map) == "criminal_gang"] <- "criminal gang"
names(regso_topic_map)[names(regso_topic_map) == "housing_queue"] <- "housing queue"

```
## 10.4 stockholm county: map high/low econimic standard and immigrants neighborhoods
```{r}
library(tmap)
tmap_mode("plot")
#tmap_mode("view")
# low economic standard
#quantile(regso_topic_map$`low economic standard%`, na.rm = T)
loweco_map <- tm_shape(regso_topic_map) +
  tm_polygons("low economic standard%",
              palette = rev(hcl.colors(7, "viridis")),
              colorNA = "white",
              border.col = "grey40", 
              border.alpha = 0.3,
              breaks = c(0,5,10,20,40,60)) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: Statistics Sweden (SCB)", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(legend.title.size = 1,
            legend.text.size = 0.75,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "Low economic standard neighborhoods",
            main.title.position = "center",
            main.title.size = 1)

# high economic standard
higheco_map <- tm_shape(regso_topic_map) +
  tm_polygons("high economic standard%",
              palette = rev(hcl.colors(7, "viridis")),
              colorNA = "white",
              border.col = "grey40", 
              border.alpha = 0.3,
              breaks = c(0,5,10,20,40,60)) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: Statistics Sweden (SCB)", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(legend.title.size = 1,
            legend.text.size = 0.8,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "High economic standard neighborhoods",
            main.title.position = "center",
            main.title.size = 1)
#tmap_save(higheco_map, "higheco_map.png", dpi = 1000)

# non-eu residents
non_eu_map <- tm_shape(regso_topic_map) + 
  tm_polygons("non-EU%", 
              palette = rev(hcl.colors(7, "viridis")),
              colorNA = "white",
              border.col = "grey40", 
              border.alpha = 0.3,
              breaks = c(0,5,10,20,40,60)) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: Statistics Sweden (SCB)", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(legend.title.size = 1,
            legend.text.size = 0.8,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "Non-EU residents in neighborhoods",
            main.title.position = "center",
            main.title.size = 1)

pre_secondary_map <- tm_shape(regso_topic_map) + 
  tm_polygons("pre secondary", 
              palette = rev(hcl.colors(7, "viridis")),
              colorNA = "white",
              border.col = "grey40", 
              border.alpha = 0.3,
              breaks = c(0,5,10,15,25,35)) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: Statistics Sweden (SCB)", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(legend.title.size = 1,
            legend.text.size = 0.8,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "Pre-secondary residnets neighborhoods",
            main.title.position = "center",
            main.title.size = 1)

edu_missing_map <- tm_shape(regso_topic_map) + 
  tm_polygons("edu info missing", 
              palette = rev(hcl.colors(7, "viridis")),
              colorNA = "white",
              border.col = "grey40", 
              border.alpha = 0.1,
              breaks = c(0,3,6,9,12)) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: Statistics Sweden (SCB)", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(legend.title.size = 1,
            legend.text.size = 0.8,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "Education informaiton missing residents neighborhoods",
            main.title.position = "center",
            main.title.size = 1)
#tmap_save(tm, "my_map.png", width = 1000, height = 750, dpi = 300)
```
## 10.5 stockholm county: map topics on neighborhoods
```{r}
criminal_gang_map <- tm_shape(regso_topic_map) +
  tm_polygons("criminal gang",
              palette = rev(hcl.colors(7, "YlGnBu")),
              colorNA = "white",
              border.col = "grey40",
              border.alpha = 0.3,
              breaks = c(0,5,10,30,50,100)) +
  #tm_facets(sync = T, ncol = 2) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: LDA model, author's calculation", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(#title = "crime222",
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "The probability of criminal gang topic",
            main.title.position = "center",
            main.title.size = 1)

crime_map <- tm_shape(regso_topic_map) +
  tm_polygons("crime",
              palette = rev(hcl.colors(7, "YlGnBu")),
              colorNA = "white",
              border.col = "grey40",
              border.alpha = 0.3,
              breaks = c(10,30,50,60,70,100)) +
  #tm_facets(sync = T, ncol = 2) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: LDA model, author's calculation", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(#title = "crime222",
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "The probability of crime topic",
            main.title.position = "center",
            main.title.size = 1)

quantile(regso_topic_map$`high status`, na.rm = T)
quantile(regso_topic_map$`criminal gang`, na.rm = T)
#tmap_save(loweco_map, "lowhigheco_map.png", dpi = 1000)

high_status_map <- tm_shape(regso_topic_map) +
  tm_polygons("high status",
              palette = rev(hcl.colors(7, "YlGnBu")),
              colorNA = "white",
              border.col = "grey40",
              border.alpha = 0.3,
              breaks = c(0,5,10,15,50,100)) +
  #tm_facets(sync = T, ncol = 2) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: LDA model, author's calculation", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(#title = "crime222",
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "The probability of high status topic",
            main.title.position = "center",
            main.title.size = 1)

immigrant_map <- tm_shape(regso_topic_map) +
  tm_polygons("immigrant",
              palette = rev(hcl.colors(7, "YlGnBu")),
              colorNA = "white",
              border.col = "grey40",
              border.alpha = 0.3,
              breaks = c(0,5,10,15,50,100)) +
  #tm_facets(sync = T, ncol = 2) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: LDA model, author's calculation", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(#title = "crime222",
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "The probability of immigrant topic",
            main.title.position = "center",
            main.title.size = 1)

traffic_map <- tm_shape(regso_topic_map) +
  tm_polygons("traffic",
              palette = rev(hcl.colors(7, "YlGnBu")),
              colorNA = "white",
              border.col = "grey40",
              border.alpha = 0.3,
              breaks = c(0,5,10,15,35,55)) +
  #tm_facets(sync = T, ncol = 2) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: LDA model, author's calculation", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(#title = "crime222",
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "The probability of traffic topic",
            main.title.position = "center",
            main.title.size = 1)
quantile(regso_topic_map$traffic, na.rm = T)

housing_queue_map <- tm_shape(regso_topic_map) +
  tm_polygons("housing queue",
              palette = rev(hcl.colors(7, "YlGnBu")),
              colorNA = "white",
              border.col = "grey40",
              border.alpha = 0.3,
              breaks = c(0,5,10,15,35,60)) +
  #tm_facets(sync = T, ncol = 2) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Data source: LDA model, author's calculation", fontface = "italic", align = "right",
             position = "right") +
  tm_legend(#title = "crime222",
            legend.title.size = 1,
            legend.text.size = 0.8,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 0.3,
            main.title = "The probability of housing queue topic",
            main.title.position = "center",
            main.title.size = 1)
quantile(regso_topic_map$`housing queue`, na.rm = T)
```
## 10.6 Map Neighborhood *mentions* on Flashback
Map 1. Neighborhoods with proportions of non-EU residents and log neighborhood mentions in Stockholm municipality (N = 97)  
```{r}
library(tmaptools)
top_mention_name_geom <- regso_topic_map %>% 
  filter(top != "NA")
top_name_geom <- regso_topic_map %>% 
  filter(top != "NA")

stkh_mentions <- tm_shape(regso_topic_map[regso_topic_map$kommunnamn == "Stockholm",]) +
  tm_polygons("n",
              #palette = get_brewer_pal(palette=rev("RdYlGn"), n=4, plot = F, contrast = c(0,1)),
              #palette = rev(hcl.colors(7, "viridis")),
              style ="cont", palette = "seq",
              colorNA = "gray",
              border.col = "grey40", 
              border.alpha = 0.5,
              textNA = "No Flashback mentions",
              title = "Log mentions",
              legend.text.size = 0.75,
              legend.show = T) + 
              #breaks = c(0,5,0,5,75)) +
  tm_layout(aes.palette = list(seq = "-RdYlGn")) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Source: Author's calculation",
             fontface = "italic", align = "right",size = 0.7,
             position = c(0.03,0)) +
  tm_legend(legend.title.size = 0.75,
            legend.text.size = 0.75,
            legend.position = c(0.03,0.05),
            legend.bg.color = "white",
            legend.bg.alpha = 0,
            main.title = "Neighborhood mentions",
            main.title.position = "center",
            main.title.size = 0.75) +
  tm_shape(top_name_geom) + 
  tm_markers(size= 0.25, col = "black", style="cont", shapeNA = NA)+
  tm_text("top", col = "black", size= 0.75, just = c(-0.15,0))
stkh_mentions
```
## 10.7 Map high/low econimic standard and immigrants neighborhoods *Stockholm municipality*
```{r}
top_name_geom <- regso_topic_map %>% 
  filter(top != "NA")
## stockholm municipality loweco map
stkh_loweco_map <- tm_shape(regso_topic_map[regso_topic_map$kommunnamn == "Stockholm",]) +
  tm_polygons("low_ecos",
              style ="cont", palette = "div",
              colorNA = "gray",
              border.col = "grey40", 
              border.alpha = 0.5,
              textNA = "No Flashback mentions",
              title = "Low economic standard%",
              legend.text.size = 0.75,
              legend.show = T) + 
  tm_layout(aes.palette = list(div = "-RdYlGn")) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Source: Statistics Sweden (SCB)",
             fontface = "italic", align = "right", size = 0.75,
             position = c(0.03,0)) +
  tm_legend(legend.title.size = 0.75,
            legend.text.size = 0.75,
            legend.position = c(0.03,0.05),
            legend.bg.color = "white",
            legend.bg.alpha = 0,
            main.title = "Low economic standard neighborhoods",
            main.title.position = "center",
            main.title.size = 0.75) +
  tm_shape(top_name_geom) + 
  tm_markers(size= 0.2, col = "black", style="cont", shapeNA = NA)+
  tm_text("top", col = "black", size= 0.75, just = c(-0.15,0))
#stkh_loweco_map

## stockholm municipality higheco map
stkh_higheco_map <- tm_shape(regso_topic_map[regso_topic_map$kommunnamn == "Stockholm",]) +
  tm_polygons("high_ecos",
              style ="cont", palette = "div",
              colorNA = "gray",
              border.col = "grey40", 
              border.alpha = 0.5,
              textNA = "No Flashback mentions",
              title = "High economic standard%",
              legend.text.size = 0.75,
              legend.show = T) + 
  tm_layout(aes.palette = list(div = "-RdYlGn")) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Source: Statistics Sweden (SCB)",
             fontface = "italic", align = "right", size = 0.75,
             position = c(0.03,0)) +
  tm_legend(legend.title.size = 0.75,
            legend.text.size = 0.75,
            legend.position = c(0.03,0.05),
            legend.bg.color = "white",
            legend.bg.alpha = 0,
            main.title = "High economic standard neighborhoods",
            main.title.position = "center",
            main.title.size = 0.75) +
  tm_shape(top_name_geom) + 
  tm_markers(size= 0.2, col = "black", style="cont", shapeNA = NA)+
  tm_text("top", col = "black", size= 0.75, just = c(-0.15,0))
#stkh_higheco_map

## stockholm municipality lowedu map
stkh_lowedu_map <- tm_shape(regso_topic_map[regso_topic_map$kommunnamn == "Stockholm",]) +
  tm_polygons("pre_secondary",
              style ="cont", palette = "div",
              colorNA = "gray",
              border.col = "grey40", 
              border.alpha = 0.5,
              textNA = "No Flashback mentions",
              title = "Pre-secondary%",
              legend.text.size = 0.75,
              legend.show = T) + 
  tm_layout(aes.palette = list(div = "-RdYlGn")) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Source: Statistics Sweden (SCB)",
             fontface = "italic", align = "right", size = 0.75,
             position = c(0.03,0)) +
  tm_legend(legend.title.size = 0.75,
            legend.text.size = 0.75,
            legend.position = c(0.03,0.05),
            legend.bg.color = "white",
            legend.bg.alpha = 0,
            main.title = "Pre-secondary residents neighborhoods",
            main.title.position = "center",
            main.title.size = 0.75) +
  tm_shape(top_name_geom) + 
  tm_markers(size= 0.2, col = "black", style="cont", shapeNA = NA)+
  tm_text("top", col = "black", size= 0.75, just = c(-0.15,0))
#stkh_lowedu_map

## stockholm municipality highedu map
stkh_highedu_map <- tm_shape(regso_topic_map[regso_topic_map$kommunnamn == "Stockholm",]) +
  tm_polygons("post_secondary_3",
              style ="cont", palette = "div",
              colorNA = "gray",
              border.col = "grey40", 
              border.alpha = 0.5,
              textNA = "No Flashback mentions",
              title = "3+ post-secondary%",
              legend.text.size = 0.75,
              legend.show = T) + 
  tm_layout(aes.palette = list(div = "-RdYlGn")) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Source: Statistics Sweden (SCB)", size = 0.75,
             fontface = "italic", align = "right",
             position = c(0.03,0)) +
  tm_legend(legend.title.size = 0.75,
            legend.text.size = 0.75,
            legend.position = c(0.03,0.05),
            legend.bg.color = "white",
            legend.bg.alpha = 0,
            main.title = "3+ post-secondary residents neighborhoods",
            main.title.position = "center",
            main.title.size = 0.75) +
  tm_shape(top_name_geom) + 
  tm_markers(size= 0.2, col = "black", style="cont", shapeNA = NA)+
  tm_text("top", col = "black", size= 0.75, just = c(-0.15,0))
#stkh_highedu_map

## stockholm municipality non-EU map
stkh_nonEU_map <- tm_shape(regso_topic_map[regso_topic_map$kommunnamn == "Stockholm",]) +
  tm_polygons("nonEU",
              style ="cont", palette = "div",
              colorNA = "gray",
              border.col = "grey40", 
              border.alpha = 0.5,
              textNA = "No Flashback mentions",
              title = "Non-EU%",
              legend.text.size = 0.75,
              legend.show = T) + 
  tm_layout(aes.palette = list(div = "-RdYlGn")) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Source: Statistics Sweden (SCB)", size = 0.75,
             fontface = "italic", align = "right",
             position = c(0.03,0)) +
  tm_legend(legend.title.size = 0.75,
            legend.text.size = 0.75,
            legend.position = c(0.03,0.05),
            legend.bg.color = "white",
            legend.bg.alpha = 0,
            main.title = "Non-EU residents neighborhoods",
            main.title.position = "center",
            main.title.size = 0.75) +
  tm_shape(top_name_geom) + 
  tm_markers(size= 0.2, col = "black", style="cont", shapeNA = NA)+
  tm_text("top", col = "black", size= 0.75, just = c(-0.15,0))
#stkh_nonEU_map
```
## 10.7.1 Arrange and save maps *Stockholm municipality*
Map 2. Neighborhoods Demographics in Stockholm City (N = 97)
Map 3. Mean centered probability of topics for neighborhoods in Stockholm City (N = 97) 
```{r}
demographics_map <- tmap_arrange(stkh_loweco_map, stkh_higheco_map,stkh_lowedu_map,stkh_highedu_map)
tmap_save(demographics_map, "demographics_map.png", dpi = 1000)

# non-EU and mentiosn
noneu_mention_map <- tmap_arrange(stkh_nonEU_map, stkh_mentions)
tmap_save(noneu_mention_map, "noneu_mention_map.png", dpi = 1000)
```
## 10.8 Map topics *Stockholm municipality*
```{r}
## crime topic
# assign lattitude and longitude for neighborhood to mark them on maps
top_name_geom <- regso_topic_map %>% 
  filter(top != "NA")

stkh_crime_topic_map <- tm_shape(regso_topic_map[regso_topic_map$kommunnamn == "Stockholm",]) +
  tm_polygons("crime",
              style ="cont", palette = "div",
              colorNA = "gray",
              border.col = "grey40", 
              border.alpha = 0.5,
              textNA = "No Flashback mentions",
              title = "Crime topic",
              legend.text.size = 0.75,
              legend.show = T) + 
  tm_layout(aes.palette = list(div = "-RdYlGn")) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Source: LDA model, author's calculation",
             fontface = "italic", align = "right", size = 0.75,
             position = c(0.03,0)) +
  tm_legend(legend.title.size = 0.75,
            legend.text.size = 0.75,
            legend.position = c(0.03,0.05),
            legend.bg.color = "white",
            legend.bg.alpha = 0,
            main.title = "The probability of crime topic",
            main.title.position = "center",
            main.title.size = 0.75) +
  tm_shape(top_name_geom) + 
  tm_markers(size= 0.2, col = "black", style="cont", shapeNA = NA)+
  tm_text("top", col = "black", size= 0.75, just = c(-0.15,0))
#stkh_crime_topic_map

## high status topic
stkh_high_status_topic_map <- tm_shape(regso_topic_map[regso_topic_map$kommunnamn == "Stockholm",]) +
  tm_polygons("high status",
              style ="cont", palette = "div",
              colorNA = "gray",
              border.col = "grey40", 
              border.alpha = 0.5,
              textNA = "No Flashback mentions",
              title = "High status topic",
              legend.text.size = 0.75,
              legend.show = T) + 
  tm_layout(aes.palette = list(div = "-RdYlGn")) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Source: LDA model, author's calculation", size = 0.75,
             fontface = "italic", align = "right",
             position = c(0.03,0)) +
  tm_legend(legend.title.size = 0.75,
            legend.text.size = 0.75,
            legend.position = c(0.03,0.05),
            legend.bg.color = "white",
            legend.bg.alpha = 0,
            main.title = "The probability of high status topic",
            main.title.position = "center",
            main.title.size = 0.75) +
  tm_shape(top_name_geom) + 
  tm_markers(size= 0.2, col = "black", style="cont", shapeNA = NA)+
  tm_text("top", col = "black", size= 0.75, just = c(-0.15,0))
#stkh_high_status_topic_map

## immigrant
stkh_immigrant_topic_map <- tm_shape(regso_topic_map[regso_topic_map$kommunnamn == "Stockholm",]) +
  tm_polygons("immigrant",
              style ="cont", palette = "div",
              colorNA = "gray",
              border.col = "grey40", 
              border.alpha = 0.5,
              textNA = "No Flashback mentions",
              title = "Immigrant topic",
              legend.text.size = 0.75,
              legend.show = T) + 
  tm_layout(aes.palette = list(div = "-RdYlGn")) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Source: LDA model, author's calculation",
             fontface = "italic", align = "right",size = 0.75,
             position = c(0.03,0)) +
  tm_legend(legend.title.size = 0.75,
            legend.text.size = 0.75,
            legend.position = c(0.03,0.05),
            legend.bg.color = "white",
            legend.bg.alpha = 0,
            main.title = "The probability of immigrant topic",
            main.title.position = "center",
            main.title.size = 0.75) +
  tm_shape(top_name_geom) + 
  tm_markers(size= 0.2, col = "black", style="cont", shapeNA = NA)+
  tm_text("top", col = "black", size= 0.75, just = c(-0.15,0))
stkh_immigrant_topic_map

## housing quequ 
stkh_housing_queue_topic_map <- tm_shape(regso_topic_map[regso_topic_map$kommunnamn == "Stockholm",]) +
  tm_polygons("housing queue",
              style ="cont", palette = "div",
              colorNA = "gray",
              border.col = "grey40", 
              border.alpha = 0.5,
              textNA = "No Flashback mentions",
              title = "Housing queue topic",
              legend.text.size = 0.75,
              legend.show = T) + 
  tm_layout(aes.palette = list(div = "-RdYlGn")) +
  tmap_style("col_blind") +
  tm_compass(type = "4star", size = 1, position = c("right", "top")) +
  tm_credits("Source: LDA model, author's calculation",
             fontface = "italic", align = "right",size = 0.75,
             position = c(0.03,0)) +
  tm_legend(legend.title.size = 0.75,
            legend.text.size = 0.75,
            legend.position = c(0.03,0.05),
            legend.bg.color = "white",
            legend.bg.alpha = 0,
            main.title = "The probability of housing queue topic",
            main.title.position = "center",
            main.title.size = 0.75) +
  tm_shape(top_name_geom) + 
  tm_markers(size= 0.2, col = "black", style="cont", shapeNA = NA)+
  tm_text("top", col = "black", size= 0.75, just = c(-0.15,0))
stkh_housing_queue_topic_map
```
## 10.8.1 combine topic maps *Stockholm municipality*
```{r}
topic_map <- tmap_arrange(stkh_crime_topic_map,stkh_high_status_topic_map, stkh_immigrant_topic_map, stkh_housing_queue_topic_map)
tmap_save(topic_map, "topic_map.png", dpi = 1000)
```
## 10.9 Html map, interactive mode
```{r}
tmap_save(non_eu_map, "non_eu_map.html")
tmap_save(pre_secondary_map, "pre_secondary_map.html")
tmap_save(edu_missing_map, "edu_missing_map.html")
tmap_save(loweco_map, "loweco_map.html")
tmap_save(higheco_map, "higheco_map.html")
tmap_save(criminal_gang_map, "criminal_gang_map.html")
tmap_save(crime_map, "crime_map.html")
tmap_save(immigrant_map, "immigrant_map.html")
tmap_save(traffic_map, "traffic_map.html")
tmap_save(housing_queue_map, "housing_queue_map.html")
tmap_save(high_status_map, "high_status_map.html")
```